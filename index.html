<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>for you</title>

    <!-- Google Fonts for romantic readable typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Manrope:wght@500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Confetti library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --bg1: #f3d6ff; /* Softer purple-pink gradient start */
            --bg2: #ffebf8; /* Light pink end */
            --card: #ffffffdd; /* Slightly more opaque for better readability */
            --yes: #d946ef; /* Vibrant purple-pink */
            --yesHover: #c026d3; /* Darker hover */
            --ink: #2e1065; /* Deep purple ink */
            --muted: rgba(76, 29, 149, .68); /* Purple-muted */
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100svh;
            display: grid;
            place-items: center;
            background: radial-gradient(circle at top, var(--bg2), var(--bg1));
            font-family: 'Manrope', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            overflow: hidden;
            padding: 16px;
        }

        /* FULL-SCREEN CONFETTI CANVAS */
        #confettiCanvas {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 9999;
        }

        .card {
            width: min(720px, 92vw);
            padding: 26px 22px;
            background: var(--card);
            backdrop-filter: blur(12px); /* Enhanced blur */
            border-radius: 28px; /* Softer corners */
            text-align: center;
            box-shadow: 0 20px 70px rgba(76, 29, 149, .18); /* Purple shadow */
            position: relative;
            z-index: 2;
            border: 1px solid rgba(255, 255, 255, 0.5); /* Subtle border */
        }

        .art {
            width: min(260px, 80vw);
            margin: 0;
            display: block;
            filter: drop-shadow(0 12px 16px rgba(76, 29, 149, .14)); /* Enhanced shadow */
        }

        .art-wrap {
            position: relative;
            display: inline-block;
            margin-bottom: 10px;
        }

        .art-overlay {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 10px;
            padding: 0 8px;
            max-width: calc(100% - 16px);
            background: transparent;
            color: rgba(255, 255, 255, .96);
            font-weight: 800;
            font-size: 14px;
            letter-spacing: .2px;
            text-shadow: 0 2px 12px rgba(0, 0, 0, .55);
            box-shadow: none;
            pointer-events: none;
            text-align: center;
        }

        h1 {
            font-size: clamp(28px, 4.2vw, 48px);
            margin: 12px 0 18px;
            font-family: 'Playfair Display', 'Manrope', serif;
            color: var(--ink);
            text-shadow: 0 2px 4px rgba(0, 0, 0, .1);
        }

        .button-zone {
            position: relative;
            width: min(520px, 92%);
            height: 150px;
            margin: 0 auto;
            touch-action: none;
        }

        .button-zone button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            padding: 16px 24px;
            font-size: 18px;
            font-weight: 700;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            box-shadow: 0 10px 24px rgba(76, 29, 149, .16); /* Purple shadow */
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: transform .15s ease, background .15s ease;
            font-family: 'Manrope', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        #yesBtn {
            left: 18%;
            background: linear-gradient(135deg, var(--yes), #f472b6); /* Gradient for attractiveness */
            color: #fff;
        }

        #yesBtn:hover {
            background: linear-gradient(135deg, var(--yesHover), #ec4899);
        }

        #noBtn {
            left: 62%;
            background: #e9d5ff; /* Light purple-gray */
            color: var(--ink);
        }

        .hint {
            margin-top: 10px;
            font-size: 13px;
            opacity: .7;
            font-style: italic;
        }

        .result {
            display: none;
            margin-top: 18px;
            animation: pop .35s ease;
        }

        .result h2 {
            font-size: clamp(32px, 4.8vw, 50px);
            margin: 10px 0;
            font-family: 'Playfair Display', 'Manrope', serif;
        }

        .fireworks {
            width: min(380px, 90vw);
            margin: 0 auto;
            display: block;
            border-radius: 18px;
        }

        /* ---------- LOVE ALARM (INTRO STORY) ---------- */
        #heartLayer {
            position: fixed;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 1;
            opacity: 1;
            transition: opacity .45s ease;
        }

        #heartLayer.is-leaving {
            opacity: 0;
        }

        .heart {
            position: absolute;
            bottom: -28px;
            left: var(--x);
            width: var(--s);
            height: var(--s);
            background: var(--c);
            transform: translate3d(-50%, 0, 0) rotate(45deg);
            border-radius: 6px;
            opacity: 0;
            filter: drop-shadow(0 10px 14px rgba(76, 29, 149, .14)); /* Purple shadow */
            animation: heartFloat var(--d) linear forwards;
        }

        .heart::before,
        .heart::after {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            background: inherit;
            border-radius: 999px;
        }

        .heart::before {
            top: -50%;
            left: 0;
        }

        .heart::after {
            top: 0;
            left: -50%;
        }

        @keyframes heartFloat {
            0% {
                transform: translate3d(-50%, 0, 0) rotate(45deg) scale(.9);
                opacity: 0;
            }

            12% {
                opacity: .92;
            }

            100% {
                transform: translate3d(calc(-50% + var(--dx)), -120vh, 0) rotate(45deg) scale(.7);
                opacity: 0;
            }
        }

        .story {
            opacity: 1;
            transform: none;
            transition: opacity .5s ease, transform .5s ease;
        }

        .story.is-leaving {
            opacity: 0;
            transform: translateY(10px) scale(.98);
        }

        .story__frame {
            width: min(560px, 100%);
            margin: 0 auto 16px;
            position: relative;
            overflow: hidden;
            border-radius: 22px; /* Softer */
            box-shadow: 0 8px 20px rgba(76, 29, 149, .12);
        }

        .story__img {
            width: 100%;
            max-height: 56svh;
            object-fit: cover;
            border-radius: inherit;
            display: block;
            transition: transform .3s ease;
        }

        .story__frame:hover .story__img {
            transform: scale(1.02); /* Subtle hover effect */
        }

        .story__caption {
            position: absolute;
            inset: 0;
            border-radius: inherit;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            gap: 6px;
            padding: 14px 14px 12px;
            text-align: center;
            background: linear-gradient(to top, rgba(76, 29, 149, .58), rgba(0, 0, 0, 0) 62%); /* Purple gradient */
            color: #fff;
        }

        .story__line {
            font-weight: 700;
            letter-spacing: .3px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, .35);
            font-size: clamp(15px, 3vw, 20px);
            font-family: 'Playfair Display', 'Manrope', serif;
        }

        .story__controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .battery-wrap {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 999px;
            background: rgba(255, 255, 255, .75); /* Slightly brighter */
            border: 1px solid rgba(76, 29, 149, .12); /* Purple border */
        }

        .battery {
            position: relative;
            width: min(320px, 72vw);
            height: 18px;
            border-radius: 999px;
            border: 2px solid rgba(76, 29, 149, .22); /* Purple border */
            overflow: hidden;
            background: rgba(255, 255, 255, .82);
        }

        .battery::after {
            content: "";
            position: absolute;
            right: -10px;
            top: 50%;
            width: 12px;
            height: 10px;
            transform: translateY(-50%);
            border-radius: 4px;
            background: rgba(76, 29, 149, .22);
        }

        .battery__fill {
            width: 3%;
            height: 100%;
            border-radius: inherit;
            background: linear-gradient(90deg, var(--yes), #f472b6); /* Gradient fill */
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, .25);
            transition: width .4s ease-out;
        }

        .battery__pct {
            font-weight: 900;
            color: var(--ink);
            min-width: 52px;
            text-align: right;
        }

        .battery-wrap.is-charging {
            animation: batteryPulse 1.1s ease-in-out infinite;
        }

        .battery-wrap.is-charging .battery {
            border-color: rgba(217, 70, 239, .55); /* Purple charging */
        }

        .battery-wrap.is-charging .battery__fill {
            filter: drop-shadow(0 0 10px rgba(217, 70, 239, .35));
        }

        @keyframes batteryPulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(217, 70, 239, .26);
            }

            50% {
                box-shadow: 0 0 0 10px rgba(217, 70, 239, 0);
            }
        }

        .battery-wrap.is-full {
            animation: batteryFull .48s ease-out 1;
        }

        .battery-wrap.is-full .battery {
            border-color: rgba(217, 70, 239, .68);
        }

        @keyframes batteryFull {
            from {
                transform: scale(1);
            }

            40% {
                transform: scale(1.03);
            }

            to {
                transform: scale(1);
            }
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 22px;
            font-size: 16px;
            font-weight: 700;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            background: linear-gradient(135deg, var(--yes), #f472b6); /* Attractive gradient */
            color: #fff;
            box-shadow: 0 10px 24px rgba(76, 29, 149, .16);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: transform .15s ease, background .15s ease, opacity .15s ease;
            font-family: 'Manrope', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .action-btn:hover {
            background: linear-gradient(135deg, var(--yesHover), #ec4899);
            transform: scale(1.02);
        }

        .action-btn:active {
            transform: scale(.98);
        }

        .action-btn:disabled {
            opacity: .7;
            cursor: not-allowed;
        }

        .proposal.card--enter {
            animation: pop .35s ease;
        }

        /* ---------- REASONS STAGE (CLICK-TO-REVEAL CARDS) ---------- */
        .reasons {
            position: fixed;
            inset: 0;
            z-index: 3;
            pointer-events: auto;
            opacity: 0;
            transform: translateY(8px) scale(.99);
            transition: opacity .45s ease, transform .45s ease;
            background: radial-gradient(circle at top, rgba(255, 238, 246, .92), rgba(255, 214, 231, .92));
            backdrop-filter: blur(8px);
        }

        .reasons.is-active {
            opacity: 1;
            transform: none;
        }

        .reasons.is-leaving {
            opacity: 0;
            transform: translateY(10px) scale(.99);
        }

        .reasons__hud {
            position: fixed;
            top: 14px;
            left: 50%;
            transform: translateX(-50%);
            width: min(720px, calc(100% - 32px));
            padding: 12px 14px 11px;
            border-radius: 18px;
            background: rgba(255, 255, 255, .72);
            border: 1px solid rgba(17, 24, 39, .10);
            box-shadow: 0 14px 44px rgba(0, 0, 0, .12);
            text-align: center;
            pointer-events: none;
        }

        .reasons__title {
            font-weight: 950;
            color: var(--ink);
            letter-spacing: .2px;
            font-size: clamp(18px, 3.8vw, 24px);
            font-family: 'Playfair Display', 'Manrope', serif;
        }

        .reasons__sub {
            margin-top: 2px;
            color: var(--muted);
            font-weight: 750;
            font-size: 13px;
        }

        .reasons__progress {
            margin-top: 6px;
            font-size: 12px;
            color: rgba(17, 24, 39, .58);
        }

        .reasons__field {
            position: absolute;
            inset: 0;
            pointer-events: auto;
        }

        .reasons__cta {
            position: fixed;
            left: 50%;
            bottom: 18px;
            transform: translateX(-50%);
            z-index: 80;
            pointer-events: none;
        }

        .reasons__cta .action-btn {
            pointer-events: auto;
            padding-inline: 20px;
        }

        .reason-card {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) rotate(var(--r, 0deg));
            width: min(170px, 44vw);
            height: 96px;
            border: none;
            background: transparent;
            padding: 0;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
            perspective: 900px;
        }

        .reason-card:focus-visible {
            outline: 3px solid rgba(255, 59, 122, .45);
            outline-offset: 4px;
            border-radius: 18px;
        }

        .reason-card__inner {
            display: block;
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform .55s cubic-bezier(.2, .9, .2, 1);
            will-change: transform;
        }

        .reason-card.is-revealed .reason-card__inner {
            transform: rotateY(180deg);
        }

        .reason-card__face {
            position: absolute;
            inset: 0;
            border-radius: 18px;
            box-shadow: 0 14px 38px rgba(0, 0, 0, .14);
            backface-visibility: hidden;
            display: grid;
            place-items: center;
            padding: 12px 12px;
        }

        .reason-card__front {
            background: linear-gradient(135deg, rgba(255, 59, 122, .95), rgba(255, 140, 177, .92));
            color: #fff;
            font-weight: 950;
            letter-spacing: .2px;
            text-align: center;
        }

        .reason-card__front small {
            display: block;
            opacity: .92;
            font-weight: 800;
            font-size: 12px;
            margin-top: 4px;
        }

        .reason-card__back {
            transform: rotateY(180deg);
            background: rgba(255, 255, 255, .82);
            border: 1px solid rgba(17, 24, 39, .10);
            color: var(--ink);
            font-weight: 900;
            text-align: center;
            line-height: 1.22;
            padding: 12px 12px;
        }

        .reason-card.is-revealed {
            cursor: default;
        }

        @media (max-width: 420px) {
            .reason-card {
                height: 88px;
            }
        }

        /* ---------- AFTER-YES EXTRAS ---------- */
        .result__actions {
            margin-top: 12px;
            display: grid;
            place-items: center;
            gap: 10px;
        }

        .gift-card {
            width: min(560px, 100%);
            margin: 10px auto 0;
            padding: 16px 16px 14px;
            border-radius: 18px;
            background: rgba(255, 255, 255, .78);
            border: 1px solid rgba(17, 24, 39, .10);
            box-shadow: 0 16px 48px rgba(0, 0, 0, .14);
            text-align: left;
            animation: pop .35s ease;
        }

        .gift-card h3 {
            margin: 0 0 10px;
            font-size: 18px;
        }

        .gift-card ul {
            margin: 0;
            padding-left: 18px;
        }

        .gift-card li {
            margin: 6px 0;
            font-weight: 800;
            color: rgba(17, 24, 39, .86);
        }

        .made-with-love {
            position: fixed;
            left: 50%;
            bottom: 12px;
            transform: translateX(-50%);
            z-index: 4;
            font-size: 12px;
            font-weight: 800;
            color: rgba(17, 24, 39, .62);
            background: rgba(255, 255, 255, .55);
            border: 1px solid rgba(17, 24, 39, .10);
            padding: 8px 12px;
            border-radius: 999px;
            backdrop-filter: blur(8px);
        }

        @media (prefers-reduced-motion: reduce) {
            #heartLayer {
                display: none !important;
            }

            .story {
                transition: none;
            }

            .reasons {
                transition: none;
            }

            .reason-card__inner {
                transition: none;
            }
        }

        @keyframes pop {
            from {
                transform: scale(.96);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <canvas id="confettiCanvas"></canvas>

    <!-- LOVE ALARM ‚Äì VALENTINE‚ÄôS DAY MODE (INTRO) -->
    <div id="heartLayer" aria-hidden="true"></div>

    <main class="card story" id="loveAlarm">
        <div class="story__frame">
            <img id="storyImg" class="story__img" src="images/2.jpeg" alt="A man sleeping" />

            <div class="story__caption">
                <div class="story__line" id="storyLine1">heard its valentines day in a few days.... (im so nonchalantly sleeping)</div>
                <div class="story__line" id="storyLine2">activate valentines day mode (remove my nonchalantness basically)
                </div>
            </div>
        </div>

        <div class="story__controls">
            <div class="battery-wrap" id="batteryWrap" aria-label="Love battery">
                <div class="battery" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="3">
                    <div class="battery__fill" id="batteryFill" style="width: 3%"></div>
                </div>
                <div class="battery__pct"><span id="batteryPct">3</span>%</div>
            </div>

            <button class="action-btn" id="activateBtn" type="button">Activate</button>
        </div>
    </main>

    <!-- REASONS STAGE (REVEAL ALL CARDS TO CONTINUE) -->
    <section class="reasons" id="reasonsStage" hidden>
        <div class="reasons__hud" aria-live="polite">
            <div class="reasons__title" id="reasonsTitle">things i love about you (not limited to these cards btw)</div>
            <div class="reasons__sub" id="reasonsSub">tap every card to reveal it üíó</div>
            <div class="reasons__progress"><span id="reasonsRevealed">0</span>/<span id="reasonsTotal">20</span>
                revealed</div>
        </div>
        <div class="reasons__field" id="reasonsField" aria-label="Reasons I love you"></div>
        <div class="reasons__cta" id="reasonsCta"></div>
    </section>

    <!-- EXISTING PROPOSAL UI (REVEALED AFTER INTRO) -->
    <main class="card proposal" id="proposalCard" hidden>
        <!-- ANIMAL WITH HEART -->
        <div class="art-wrap">
            <img class="art" id="artImg" src="images/3.jpeg" alt="Cute animal">
            <div class="art-overlay" id="artOverlay">i am watching you....</div>
        </div>

        <h2>annwesha will you be my valentine?</h2>

        <section class="button-zone" id="zone">
            <button id="yesBtn">Yes</button>
            <button id="noBtn">No</button>
        </section>

        <!-- HINT -->
        <div class="hint" id="hint">‚ÄúNo‚Äù seems a bit shy (pls choose yes)</div>

        <section class="result" id="result">
            <h3>YAY! üéâ</h3>

            <div class="result__actions">
                <button class="action-btn" id="giftBtn" type="button" hidden>click here to find out what package you've chosen</button>
            </div>

            <img class="fireworks" id="fireworksGif" src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExdXM1eThka2p3M2kyN2d1djVsejFzaThrZ202eXk4cXVuZTJhNndrNyZlcD12MV9naWZzX3NlYXJjaCZjdD1n/j0vs5H7Kcz3Pm9LRDa/giphy.gif"
                alt="Fireworks" />

            <div class="gift-card" id="giftCard" hidden>
                <h3>your valentine bundle includes:</h3>
                <ul>
                    <li>1 X cute nerdy loving boyfriend</li>
                    <li>1 X meal of your choice at any place (pls be affordable)</li>
                    <li>unlimited 6-7 jokes</li>
                    <li>unlimited cuddles</li>
                </ul>
            </div>
        </section>
    </main>

    <footer class="made-with-love" id="madeWithLove" hidden>made with love from your gaandu boyfriend ‚ù§Ô∏èüòâ</footer>

    <script>
        /* ---------- LOVE ALARM (INTRO STORY) ---------- */
        const heartLayer = document.getElementById("heartLayer");
        const loveAlarm = document.getElementById("loveAlarm");
        const proposalCard = document.getElementById("proposalCard");
        const storyImg = document.getElementById("storyImg");
        const storyLine1 = document.getElementById("storyLine1");
        const storyLine2 = document.getElementById("storyLine2");
        const batteryWrap = document.getElementById("batteryWrap");
        const batteryFill = document.getElementById("batteryFill");
        const batteryPct = document.getElementById("batteryPct");
        const batteryBar = batteryWrap ? batteryWrap.querySelector(".battery") : null;
        const activateBtn = document.getElementById("activateBtn");

        /* ---------- REASONS STAGE ---------- */
        const reasonsStage = document.getElementById("reasonsStage");
        const reasonsField = document.getElementById("reasonsField");
        const reasonsTitle = document.getElementById("reasonsTitle");
        const reasonsSub = document.getElementById("reasonsSub");
        const reasonsRevealed = document.getElementById("reasonsRevealed");
        const reasonsTotal = document.getElementById("reasonsTotal");
        const reasonsCta = document.getElementById("reasonsCta");

        let heartTimer = null;
        let introStarted = false;
        let moreReady = false;
        let reasonsBuilt = false;
        let reasonsDone = false;
        let revealedCount = 0;

        // Placeholder reasons (edit these later)
        const reasons = [
            "you‚Äôre very honest (and i love that)",
            "you‚Äôre patient with my nonsense (includes 67 jokes)",
            "you listen like you actually mean it",
            "you make silence feel comfortable, never awkward",
            "you hype me up when i doubt myself (i really love this about you)",
            "you roast me but still choose me",
            "you‚Äôre the cutest even when you‚Äôre annoyed (sorry i ragebait you too much)",
            "your smile fixes my mood instantly",
            "you notice the small things I don‚Äôt say out loud",
            "you understand me without needing explanations",
            "you‚Äôre kind in a way that feels rare",
            "you smile with those beautiful eyes of yours and I fold instantly",
            "your voice feels like a safe place",
            "when i am with you, you make the normal moments feel special",
            "your hugs are so warm, it makes all my problems vanish",
            "you‚Äôre my favorite person to do nothing with",
            "you make the future feel exciting instead of scary",
            "you‚Äôre beautiful in a way which i cant put into words",
            "you make me want to be a better person as a whole",
            "you make my heart feel full"
        ];

        function clampPercent(n) {
            return Math.max(0, Math.min(100, n));
        }

        function setBattery(percent) {
            const p = Math.round(clampPercent(percent));
            batteryFill.style.width = p + "%";
            batteryPct.textContent = p;
            batteryBar.setAttribute("aria-valuenow", String(p));
        }

        function spawnHeart(mode) {
            if (!heartLayer || heartLayer.hidden) return;

            const heart = document.createElement("span");
            heart.className = "heart";

            const colors = ["#d946ef", "#f472b6", "#f3d6ff", "#c026d3"]; /* Updated colors */
            const color = colors[Math.floor(Math.random() * colors.length)];

            const size = mode === "charging"
                ? 14 + Math.random() * 14
                : 10 + Math.random() * 12;

            const durationMs = mode === "charging"
                ? 1800 + Math.random() * 1500
                : 2600 + Math.random() * 2200;

            const driftPx = (Math.random() * 2 - 1) * (mode === "charging" ? 70 : 40);

            heart.style.setProperty("--x", `${Math.random() * 100}%`);
            heart.style.setProperty("--s", `${size}px`);
            heart.style.setProperty("--c", color);
            heart.style.setProperty("--d", `${durationMs}ms`);
            heart.style.setProperty("--dx", `${driftPx}px`);

            heart.addEventListener("animationend", () => heart.remove(), { once: true });
            heartLayer.appendChild(heart);
        }

        function startHearts(mode) {
            stopHearts();
            if (window.matchMedia?.("(prefers-reduced-motion: reduce)")?.matches) return;
            if (!heartLayer) return;

            const intervalMs = mode === "charging" ? 120 : 320;
            spawnHeart(mode);
            heartTimer = window.setInterval(() => spawnHeart(mode), intervalMs);
        }

        function stopHearts() {
            if (heartTimer) window.clearInterval(heartTimer);
            heartTimer = null;
        }

        function easeOutCubic(t) {
            return 1 - Math.pow(1 - t, 3);
        }

        function clampNumber(n, min, max) {
            return Math.max(min, Math.min(max, n));
        }

        function updateReasonsProgress() {
            if (reasonsTotal) reasonsTotal.textContent = String(reasons.length);
            if (reasonsRevealed) reasonsRevealed.textContent = String(revealedCount);
        }

        function layoutReasonCards() {
            if (!reasonsField) return;

            const cards = Array.from(reasonsField.querySelectorAll(".reason-card"));
            if (!cards.length) return;

            const w = window.innerWidth;
            const h = window.innerHeight;

            const cols = w < 480 ? 3 : (w < 900 ? 4 : 5);
            const rows = Math.ceil(cards.length / cols);

            const topPad = 120;
            const bottomPad = 96;
            const sidePad = 14;

            const availW = Math.max(1, w - sidePad * 2);
            const availH = Math.max(1, h - topPad - bottomPad);

            const cellW = availW / cols;
            const cellH = availH / rows;

            cards.forEach((card, i) => {
                const col = i % cols;
                const row = Math.floor(i / cols);

                const jx = parseFloat(card.dataset.jx || "0") * 0.34;
                const jy = parseFloat(card.dataset.jy || "0") * 0.34;
                const rot = parseFloat(card.dataset.r || "0");

                let x = sidePad + (col + 0.5 + jx) * cellW;
                let y = topPad + (row + 0.5 + jy) * cellH;

                // Approx half-size clamp so cards stay on-screen.
                const safeX = w < 420 ? 76 : 88;
                const safeY = 54;
                x = clampNumber(x, sidePad + safeX, w - sidePad - safeX);
                y = clampNumber(y, topPad + safeY, h - bottomPad - safeY);

                card.style.left = x + "px";
                card.style.top = y + "px";
                card.style.setProperty("--r", rot.toFixed(2) + "deg");
                card.style.zIndex = String(10 + row);
            });
        }

        function buildReasonsOnce() {
            if (reasonsBuilt) return;
            reasonsBuilt = true;

            if (!reasonsField) return;

            reasonsField.replaceChildren();
            if (reasonsCta) reasonsCta.replaceChildren();
            revealedCount = 0;
            reasonsDone = false;
            updateReasonsProgress();

            if (reasonsTitle) reasonsTitle.textContent = "things i love about you (not limited to these cards btw)";
            if (reasonsSub) reasonsSub.textContent = "tap every card to reveal it üíó";

            reasons.forEach((reason) => {
                const card = document.createElement("button");
                card.type = "button";
                card.className = "reason-card";
                card.setAttribute("aria-label", "Reveal a reason");
                card.setAttribute("aria-pressed", "false");

                // Store random layout offsets once so positions remain stable.
                card.dataset.jx = String(Math.random() - 0.5);
                card.dataset.jy = String(Math.random() - 0.5);
                card.dataset.r = String((Math.random() * 2 - 1) * 12);

                const inner = document.createElement("span");
                inner.className = "reason-card__inner";

                const front = document.createElement("span");
                front.className = "reason-card__face reason-card__front";
                front.innerHTML = "tap üíó<small>reveal</small>";

                const back = document.createElement("span");
                back.className = "reason-card__face reason-card__back";
                back.textContent = reason;

                inner.append(front, back);
                card.append(inner);

                card.addEventListener("click", () => {
                    if (reasonsDone) return;
                    if (card.classList.contains("is-revealed")) return;

                    card.classList.add("is-revealed");
                    card.setAttribute("aria-pressed", "true");

                    revealedCount += 1;
                    updateReasonsProgress();

                    if (revealedCount >= reasons.length) {
                        reasonsDone = true;

                        if (reasonsTitle) reasonsTitle.textContent = "all revealed üíò";
                        if (reasonsSub) reasonsSub.textContent = "click the button below for the final question ‚ú®";
                        showFinalQuestionButton();
                    }
                });

                reasonsField.appendChild(card);
            });
        }

        function showReasonsStage() {
            if (!reasonsStage || !reasonsField) {
                revealProposal();
                return;
            }

            buildReasonsOnce();
            reasonsStage.hidden = false;
            reasonsStage.classList.remove("is-leaving");

            requestAnimationFrame(() => {
                reasonsStage.classList.add("is-active");
                layoutReasonCards();
            });
        }

        function revealProposal() {
            if (!proposalCard) return;
            proposalCard.hidden = false;
            proposalCard.classList.add("card--enter");
            window.setTimeout(() => proposalCard.classList.remove("card--enter"), 400);
        }

        function handleFinalQuestion() {
            if (!reasonsStage) {
                revealProposal();
                return;
            }
            reasonsStage.classList.add("is-leaving");
            window.setTimeout(() => {
                reasonsStage.hidden = true;
                reasonsStage.classList.remove("is-leaving");
                revealProposal();
            }, 420);
        }

        function showFinalQuestionButton() {
            if (!reasonsCta) {
                // Fail open: if CTA wrapper is missing, proceed.
                handleFinalQuestion();
                return;
            }

            let btn = reasonsCta.querySelector("#finalQuestionBtn");
            if (!btn) {
                btn = document.createElement("button");
                btn.className = "action-btn";
                btn.id = "finalQuestionBtn";
                btn.type = "button";
                btn.textContent = "and... for the final question";
                btn.addEventListener("click", () => {
                    if (btn.disabled) return;
                    btn.disabled = true;
                    handleFinalQuestion();
                });
                reasonsCta.appendChild(btn);
            }

            btn.disabled = false;
        }

        function runLoveAlarmSequence() {
            if (
                !heartLayer ||
                !loveAlarm ||
                !proposalCard ||
                !storyImg ||
                !storyLine1 ||
                !storyLine2 ||
                !batteryWrap ||
                !batteryFill ||
                !batteryPct ||
                !batteryBar ||
                !activateBtn
            ) {
                // Fail open: if intro can't run, show the proposal UI.
                if (proposalCard) proposalCard.hidden = false;
                if (loveAlarm) loveAlarm.hidden = true;
                if (heartLayer) heartLayer.hidden = true;
                return;
            }

            // Initial state
            setBattery(3);

            activateBtn.addEventListener("click", () => {
                if (moreReady) {
                    moreReady = false;
                    activateBtn.disabled = true;

                    loveAlarm.classList.add("is-leaving");
                    heartLayer.classList.add("is-leaving");

                    window.setTimeout(() => {
                        loveAlarm.hidden = true;
                        stopHearts();
                        heartLayer.replaceChildren();
                        heartLayer.hidden = true;
                        showReasonsStage();
                    }, 520);
                    return;
                }

                if (introStarted) return;
                introStarted = true;

                activateBtn.disabled = true;
                activateBtn.textContent = "Activating...";
                batteryWrap.classList.add("is-charging");

                startHearts("charging");

                const from = 3;
                const to = 100;
                const durationMs = 3400;
                const start = performance.now();

                function tick(now) {
                    const t = Math.min(1, (now - start) / durationMs);
                    const eased = easeOutCubic(t);
                    setBattery(from + (to - from) * eased);

                    if (t < 1) {
                        requestAnimationFrame(tick);
                        return;
                    }

                    // Charged state
                    batteryWrap.classList.remove("is-charging");
                    batteryWrap.classList.add("is-full");
                    setBattery(100);

                    storyImg.src = "images/1.jpeg";
                    storyImg.alt = "A couple standing together";
                    storyLine1.textContent = "Love battery: 100%";
                    storyLine2.textContent = "Valentine‚Äôs Day mode activated üíò";
                    moreReady = true;
                    activateBtn.disabled = false;
                    activateBtn.textContent = "click me for more";

                    // Hearts calm down, then stop.
                    startHearts("calm");
                    window.setTimeout(stopHearts, 900);
                }

                requestAnimationFrame(tick);
            });

        }

        runLoveAlarmSequence();

        // Keep the scattered cards nicely placed on rotate/resize.
        window.addEventListener("resize", () => {
            if (reasonsStage && !reasonsStage.hidden) layoutReasonCards();
        });
        window.addEventListener("orientationchange", () => {
            window.setTimeout(() => {
                if (reasonsStage && !reasonsStage.hidden) layoutReasonCards();
            }, 150);
        });

        const zone = document.getElementById("zone");
        const yesBtn = document.getElementById("yesBtn");
        const noBtn = document.getElementById("noBtn");
        const result = document.getElementById("result");
        const hint = document.getElementById("hint");
        const artImg = document.getElementById("artImg");
        const artOverlay = document.getElementById("artOverlay");
        const giftBtn = document.getElementById("giftBtn");
        const giftCard = document.getElementById("giftCard");
        const fireworksGif = document.getElementById("fireworksGif");
        const madeWithLove = document.getElementById("madeWithLove");

        if (giftBtn) {
            giftBtn.addEventListener("click", () => {
                giftBtn.hidden = true;
                if (fireworksGif) fireworksGif.hidden = true;
                if (giftCard) {
                    giftCard.hidden = false;
                    giftCard.scrollIntoView({ behavior: "smooth", block: "center" });
                }
                if (madeWithLove) madeWithLove.hidden = false;
            });
        }

        /* ---------- CONFETTI ---------- */
        const confettiCanvas = document.getElementById("confettiCanvas");

        function resizeConfettiCanvas() {
            const dpr = Math.max(1, window.devicePixelRatio || 1);
            confettiCanvas.width = Math.floor(window.innerWidth * dpr);
            confettiCanvas.height = Math.floor(window.innerHeight * dpr);
            confettiCanvas.style.width = "100vw";
            confettiCanvas.style.height = "100vh";
        }

        resizeConfettiCanvas();
        window.addEventListener("resize", resizeConfettiCanvas);
        window.addEventListener("orientationchange", () => setTimeout(resizeConfettiCanvas, 150));

        let confettiInstance = null;
        if (window.confetti && typeof window.confetti.create === "function") {
            confettiInstance = confetti.create(confettiCanvas, {
                resize: false,
                useWorker: false
            });
        }

        function fullScreenConfetti() {
            if (!confettiInstance) return;
            const end = Date.now() + 1600;

            (function frame() {
                confettiInstance({
                    particleCount: 12,
                    spread: 90,
                    startVelocity: 45,
                    ticks: 180,
                    origin: { x: Math.random(), y: Math.random() * 0.3 }
                });
                if (Date.now() < end) requestAnimationFrame(frame);
            })();

            setTimeout(() => {
                confettiInstance({
                    particleCount: 300,
                    spread: 140,
                    startVelocity: 60,
                    ticks: 220,
                    origin: { x: 0.5, y: 0.55 }
                });
            }, 300);
        }

        /* ---------- YES BUTTON GROWS ---------- */
        let yesScale = 1;
        function growYes() {
            yesScale = Math.min(2.2, yesScale + 0.1);
            yesBtn.style.transform = `translateY(-50%) scale(${yesScale})`;
        }

        /* ---------- NO BUTTON RUNS AWAY ---------- */
        function clamp(n, min, max) {
            return Math.max(min, Math.min(max, n));
        }

        function moveNo(px, py) {
            const z = zone.getBoundingClientRect();
            const b = noBtn.getBoundingClientRect();

            let dx = (b.left + b.width / 2) - px;
            let dy = (b.top + b.height / 2) - py;
            let mag = Math.hypot(dx, dy) || 1;
            dx /= mag;
            dy /= mag;

            let newLeft = (b.left - z.left) + dx * 150;
            let newTop = (b.top - z.top) + dy * 150;

            newLeft = clamp(newLeft, 0, z.width - b.width);
            newTop = clamp(newTop, 0, z.height - b.height);

            noBtn.style.left = newLeft + "px";
            noBtn.style.top = newTop + "px";
            noBtn.style.transform = "none";

            growYes();
        }

        zone.addEventListener("pointermove", e => {
            const b = noBtn.getBoundingClientRect();
            const d = Math.hypot(
                (b.left + b.width / 2) - e.clientX,
                (b.top + b.height / 2) - e.clientY
            );
            if (d < 140) moveNo(e.clientX, e.clientY);
        });

        noBtn.addEventListener("click", e => e.preventDefault());

        /* ---------- YES CLICK ---------- */
        yesBtn.addEventListener("click", () => {
        zone.style.display = "none";
        hint.style.display = "none";     // HIDE THE HINT
        result.style.display = "block";
        artImg.src = "images/4.jpeg";
        if (artOverlay) artOverlay.textContent = "hehe";

        if (giftCard) giftCard.hidden = true;
        if (fireworksGif) fireworksGif.hidden = false;
        if (giftBtn) giftBtn.hidden = false;

        resizeConfettiCanvas();
        fullScreenConfetti();
    });
    </script>
</body>

</html>
